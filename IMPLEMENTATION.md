# ChillFlow 实现总结

## 已实现的核心功能

### ✅ F1: 菜单栏图标
- **空闲状态**：显示静态 leaf 图标
- **专注状态**：显示静态 leaf 图标
- **休息状态**：显示静态 leaf 图标 + 剩余时间（MM:SS格式）

### ✅ F2: 主控制面板
- **布局**：点击菜单栏图标展开面板，极简设计
- **Tab切换**：顶部中间有"控制"和"统计"两个tab，顶部右侧有退出按钮

#### F2.2.1：控制Tab
- **状态显示**：当前状态文字（"专注"、"休息"、"长休息"等）
- **时间显示**：MM:SS 格式的大字体倒计时
- **周期显示**：显示当前是第几个番茄钟（如 1/3）
- **核心控制按钮**：
  - 开始专注：仅在空闲状态显示，占一行
  - 暂停/继续：在专注或休息状态显示
  - 跳过：可跳过当前阶段
  - 重置：停止当前循环，返回空闲状态
- **音量控制**：底部音量滑块

#### F2.2.2：统计Tab
- **日期范围**：显示当前周（周一到周日），支持左右翻页切换不同周
- **总专注时长**：显示当前周的总专注时长
- **热力图**：7天 x 3个时间段（每8小时一段）的专注时长热力图
- **交互**：鼠标hover到热力图格子时，显示该格子的详细信息

### ✅ F3: 番茄钟核心逻辑
- **状态管理**：Idle、Focus、Rest、Long Rest、Paused
- **时长配置**：
  - Focus: 25分钟
  - Rest: 5分钟
  - Long Rest: 30分钟（根据需求1.5）
- **状态转换逻辑**：
  - Idle -> Focus(1)
  - Focus(n) 结束 -> Rest(n) (n < 3)
  - Rest(n) 结束 -> Focus(n+1) (n < 3)
  - Focus(3) 结束 -> Long Rest
  - Long Rest 结束 -> Idle
- **控制功能**：
  - 开始：从空闲状态启动第一个专注周期
  - 暂停/继续：暂停或恢复当前计时
  - 跳过：立即结束当前阶段，进入下一阶段
  - 重置：停止当前循环，返回空闲状态

### ✅ F4: 声景引擎
- **内置音轨**：支持 Focus-Track-01.mp3 和 Focus-Track-02.mp3
- **随机选择**：播放时随机选择一首专注音乐
- **循环播放**：音频无限循环
- **状态同步**：
  - Idle -> Focus：自动淡入专注音乐（3-5秒）
  - Focus -> Rest/Long Rest：自动淡出音乐（3-5秒）
  - Rest -> Focus：自动淡入专注音乐（3-5秒）
- **暂停/继续同步**：
  - 暂停：音乐平滑淡出
  - 继续：音乐平滑淡入
- **音量控制**：应用内音量滑块控制

### ✅ 统计功能
- **数据记录**：每个专注周期（25分钟）结束时自动记录
- **持久化存储**：使用 UserDefaults 保存统计数据
- **热力图展示**：7天 x 3个时间段的可视化热力图
- **周视图**：支持查看不同周的统计数据

## 技术实现

### 架构设计
- **MVVM模式**：使用 ObservableObject 实现响应式状态管理
- **Combine框架**：用于状态监听和响应式编程
- **SwiftUI**：现代化UI框架
- **AVFoundation**：音频播放和淡入淡出控制

### 核心组件
1. **TimerManager**：管理番茄钟逻辑、状态转换、计时
2. **AudioManager**：管理音频播放、淡入淡出、音量控制
3. **StatsManager**：管理统计数据、热力图计算、持久化
4. **AppDelegate**：管理菜单栏图标、弹出窗口、状态同步

### 性能优化
- 计时器使用 RunLoop.common 模式，确保后台也能正常运行
- 音频淡入淡出使用平滑的30步过渡
- 统计数据按需计算，避免性能问题

## 配置要求

### 必需配置
1. **音频文件**：需要在 Xcode 项目中添加：
   - `Focus-Track-01.mp3`
   - `Focus-Track-02.mp3`
   - 文件必须添加到 Bundle Resources

2. **Bundle Identifier**：在 Xcode 中设置唯一的 Bundle Identifier

3. **系统要求**：macOS 12.0 (Monterey) 或更高版本

### Info.plist 配置
- `LSUIElement = true`：确保应用只显示在菜单栏，不在Dock中
- `LSMinimumSystemVersion = 12.0`：最低系统版本要求

## 使用方法

1. **开始专注**：点击菜单栏图标 → 点击"开始专注"
2. **控制计时器**：使用暂停/继续、跳过、重置按钮
3. **调整音量**：使用底部音量滑块
4. **查看统计**：切换到"统计"tab查看热力图

## 注意事项

1. 音频文件必须添加到 Xcode 项目的 Bundle Resources 中才能播放
2. 如果音频文件不存在，应用仍可运行但不会播放声音
3. 统计数据保存在 UserDefaults 中，卸载应用会清除数据
4. 应用作为菜单栏应用运行，不会显示在 Dock 中

